<!-- =====================================================
     –°–¢–†–ê–ù–ò–¶–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–û–õ–ì–ê–ú–ò –ü–û–°–¢–ê–í–©–ò–ö–û–í
     –í—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é –≤ index.html
     ===================================================== -->

<!-- –°–µ–∫—Ü–∏—è "–î–æ–ª–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º" -->
<div id="section-supplier-debts" class="section" style="display: none;">
  <div class="content-wrapper">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–≤–æ–¥–∫–∞ -->
    <div class="section-header" style="margin-bottom: 24px;">
      <div>
        <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 600; color: #111827;">
          –î–æ–ª–≥–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º
        </h2>
        <p style="margin: 0; color: #6b7280; font-size: 14px;">
          –£—á—ë—Ç –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–µ–π –∏ –∏—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç
        </p>
      </div>
      
      <!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
      <button 
        onclick="window.loadDebtsPage()" 
        class="btn-primary"
        style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;"
      >
        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
      </button>
    </div>

    <!-- –°–≤–æ–¥–∫–∞ –ø–æ –¥–æ–ª–≥–∞–º -->
    <div id="debtsSummary" class="debts-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="debts-filters" style="margin-bottom: 20px; display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
      
      <div style="flex: 1; min-width: 200px;">
        <select 
          id="debtsStatusFilter" 
          onchange="window.filterDebts()"
          class="input-style"
          style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
        >
          <option value="all">–í—Å–µ –¥–æ–ª–≥–∏</option>
          <option value="open" selected>–ù–µ –æ–ø–ª–∞—á–µ–Ω—ã</option>
          <option value="partial">–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω—ã</option>
          <option value="closed">–ó–∞–∫—Ä—ã—Ç—ã–µ</option>
        </select>
      </div>

      <div style="flex: 2; min-width: 250px;">
        <input 
          type="text" 
          id="debtsSearchInput" 
          placeholder="–ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É..."
          oninput="window.filterDebts()"
          class="input-style"
          style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
        >
      </div>

    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–≥–æ–≤ -->
    <div class="debts-table-wrapper" style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
      <table class="debts-table" style="width: 100%; border-collapse: collapse;">
        <thead style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
          <tr>
            <th style="padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–î–∞—Ç–∞</th>
            <th style="padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
            <th style="padding: 12px 16px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–°—É–º–º–∞</th>
            <th style="padding: 12px 16px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–û–ø–ª–∞—á–µ–Ω–æ</th>
            <th style="padding: 12px 16px; text-align: right; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–î–æ–ª–≥</th>
            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–°—Ç–∞—Ç—É—Å</th>
            <th style="padding: 12px 16px; text-align: center; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase;">–î–µ–π—Å—Ç–≤–∏—è</th>
          </tr>
        </thead>
        <tbody id="debtsTableBody">
          <tr>
            <td colspan="7" style="padding: 40px; text-align: center; color: #9ca3af;">
              –ó–∞–≥—Ä—É–∑–∫–∞...
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ===================================================== -->
<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –û–ü–õ–ê–¢–ê –î–û–õ–ì–ê -->
<!-- ===================================================== -->

<div id="modalPayDebt" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="modal-header" style="margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #111827;">
        –û–ø–ª–∞—Ç–∞ –¥–æ–ª–≥–∞
      </h3>
      <button 
        onclick="window.closeModal('modalPayDebt')" 
        style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer;"
      >
        √ó
      </button>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–ª–≥–µ -->
    <div id="payDebtInfo" class="debt-info" style="margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <!-- –§–æ—Ä–º–∞ –æ–ø–ª–∞—Ç—ã -->
    <form id="payDebtForm" onsubmit="window.submitPayment(event)">
      
      <!-- –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã -->
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">
          –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã <span style="color: #ef4444;">*</span>
        </label>
        <input 
          type="number" 
          id="payDebtAmount" 
          name="amount"
          min="0.01"
          step="0.01"
          required
          class="input-style"
          style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
        >
        <div style="margin-top: 6px; font-size: 12px; color: #6b7280;">
          –ú–∞–∫—Å–∏–º—É–º: <span id="payDebtMaxAmount">0.00</span> ‚Ç∏
        </div>
      </div>

      <!-- –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã -->
      <div style="margin-bottom: 16px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">
          –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã <span style="color: #ef4444;">*</span>
        </label>
        <select 
          id="payDebtMethod" 
          name="paymentMethod"
          required
          class="input-style"
          style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;"
        >
          <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∏–∑ PAYMENT_METHODS -->
        </select>
      </div>

      <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #374151;">
          –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
        </label>
        <textarea 
          id="payDebtComment" 
          name="comment"
          rows="3"
          class="input-style"
          style="width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; resize: vertical;"
          placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
        ></textarea>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ -->
      <div style="display: flex; gap: 12px; justify-content: flex-end;">
        <button 
          type="button"
          onclick="window.closeModal('modalPayDebt')"
          class="btn-secondary"
          style="padding: 10px 20px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;"
        >
          –û—Ç–º–µ–Ω–∞
        </button>
        <button 
          type="submit"
          class="btn-primary"
          style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;"
        >
          üí∞ –û–ø–ª–∞—Ç–∏—Ç—å
        </button>
      </div>

    </form>

  </div>
</div>

<!-- ===================================================== -->
<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ò–°–¢–û–†–ò–Ø –û–ü–õ–ê–¢ -->
<!-- ===================================================== -->

<div id="modalPaymentHistory" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
  <div class="modal-content" style="background: white; border-radius: 12px; padding: 24px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto;">
    
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="modal-header" style="margin-bottom: 20px; border-bottom: 1px solid #e5e7eb; padding-bottom: 16px;">
      <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: #111827;">
        –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç
      </h3>
      <button 
        onclick="window.closeModal('modalPaymentHistory')" 
        style="position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: #9ca3af; cursor: pointer;"
      >
        √ó
      </button>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–ª–≥–µ -->
    <div id="historyDebtInfo" class="debt-info" style="margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç -->
    <div id="paymentHistoryList" class="payment-history-list">
      <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
    </div>

  </div>
</div>

<!-- ===================================================== -->
<!-- –°–ö–†–ò–ü–¢ –£–ü–†–ê–í–õ–ï–ù–ò–Ø –î–û–õ–ì–ê–ú–ò -->
<!-- ===================================================== -->

<script type="module">
import { 
  loadSupplierDebts, 
  loadDebtWithPayments,
  getDebtsSummary,
  paySupplierDebt,
  getPaymentHistory,
  getDebtStatusColor,
  getDebtStatusText,
  validatePayment 
} from './supplier-debts.js';

let currentDebts = [];
let selectedDebt = null;

// =============================================
// –ó–ê–ì–†–£–ó–ö–ê –°–¢–†–ê–ù–ò–¶–´ –î–û–õ–ì–û–í
// =============================================

window.loadDebtsPage = async function() {
  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–≤–æ–¥–∫—É
    const summary = await getDebtsSummary(window.COMPANY_ID);
    renderDebtsSummary(summary);

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ–ª–≥–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é - –æ—Ç–∫—Ä—ã—Ç—ã–µ)
    const status = document.getElementById('debtsStatusFilter')?.value || 'open';
    const debts = await loadSupplierDebts(window.COMPANY_ID, status);
    currentDebts = debts;
    renderDebtsTable(debts);

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–ª–≥–æ–≤:', error);
    window.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
};

// =============================================
// –û–¢–†–ò–°–û–í–ö–ê –°–í–û–î–ö–ò
// =============================================

function renderDebtsSummary(summary) {
  const container = document.getElementById('debtsSummary');
  if (!container) return;

  container.innerHTML = `
    <!-- –í—Å–µ–≥–æ –¥–æ–ª–≥–æ–≤ -->
    <div class="summary-card" style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #e5e7eb;">
      <div style="font-size: 13px; color: #6b7280; margin-bottom: 8px;">–í—Å–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</div>
      <div style="font-size: 24px; font-weight: 700; color: #111827; margin-bottom: 4px;">${summary.total.count}</div>
      <div style="font-size: 14px; color: #6b7280;">
        –°—É–º–º–∞: ${summary.total.amount.toFixed(2)} ‚Ç∏
      </div>
    </div>

    <!-- –û—Ç–∫—Ä—ã—Ç—ã–µ –¥–æ–ª–≥–∏ -->
    <div class="summary-card" style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #fee2e2; border-left: 4px solid #ef4444;">
      <div style="font-size: 13px; color: #991b1b; margin-bottom: 8px;">–ù–µ –æ–ø–ª–∞—á–µ–Ω—ã</div>
      <div style="font-size: 24px; font-weight: 700; color: #ef4444; margin-bottom: 4px;">${summary.open.count}</div>
      <div style="font-size: 14px; color: #991b1b;">
        –î–æ–ª–≥: ${summary.open.debt.toFixed(2)} ‚Ç∏
      </div>
    </div>

    <!-- –ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω—ã -->
    <div class="summary-card" style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #fed7aa; border-left: 4px solid #f59e0b;">
      <div style="font-size: 13px; color: #92400e; margin-bottom: 8px;">–ß–∞—Å—Ç–∏—á–Ω–æ</div>
      <div style="font-size: 24px; font-weight: 700; color: #f59e0b; margin-bottom: 4px;">${summary.partial.count}</div>
      <div style="font-size: 14px; color: #92400e;">
        –î–æ–ª–≥: ${summary.partial.debt.toFixed(2)} ‚Ç∏
      </div>
    </div>

    <!-- –û–ø–ª–∞—á–µ–Ω—ã -->
    <div class="summary-card" style="padding: 16px; background: white; border-radius: 8px; border: 1px solid #d1fae5; border-left: 4px solid #10b981;">
      <div style="font-size: 13px; color: #065f46; margin-bottom: 8px;">–û–ø–ª–∞—á–µ–Ω—ã</div>
      <div style="font-size: 24px; font-weight: 700; color: #10b981; margin-bottom: 4px;">${summary.closed.count}</div>
      <div style="font-size: 14px; color: #065f46;">
        –í—Å—ë –æ–ø–ª–∞—á–µ–Ω–æ
      </div>
    </div>
  `;
}

// =============================================
// –û–¢–†–ò–°–û–í–ö–ê –¢–ê–ë–õ–ò–¶–´ –î–û–õ–ì–û–í
// =============================================

function renderDebtsTable(debts) {
  const tbody = document.getElementById('debtsTableBody');
  if (!tbody) return;

  if (!debts || debts.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="padding: 40px; text-align: center; color: #9ca3af;">
          –î–æ–ª–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = debts.map(debt => {
    const date = window.formatDate(debt.created_at);
    const statusColor = getDebtStatusColor(debt.status);
    const statusText = getDebtStatusText(debt.status);
    const supplierName = debt.supplier?.name || debt.supplier_name || '–ù–µ —É–∫–∞–∑–∞–Ω';

    return `
      <tr style="border-bottom: 1px solid #e5e7eb;">
        <td style="padding: 12px 16px; color: #374151; font-size: 14px;">${date}</td>
        <td style="padding: 12px 16px; color: #111827; font-size: 14px; font-weight: 500;">${supplierName}</td>
        <td style="padding: 12px 16px; text-align: right; color: #374151; font-size: 14px;">${Number(debt.total_amount).toFixed(2)} ‚Ç∏</td>
        <td style="padding: 12px 16px; text-align: right; color: #10b981; font-size: 14px; font-weight: 500;">${Number(debt.paid_amount).toFixed(2)} ‚Ç∏</td>
        <td style="padding: 12px 16px; text-align: right; color: #ef4444; font-size: 14px; font-weight: 600;">${Number(debt.debt_amount).toFixed(2)} ‚Ç∏</td>
        <td style="padding: 12px 16px; text-align: center;">
          <span style="display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; background: ${statusColor}22; color: ${statusColor};">
            ${statusText}
          </span>
        </td>
        <td style="padding: 12px 16px; text-align: center;">
          ${debt.status !== 'closed' ? `
            <button 
              onclick="window.openPayDebtModal('${debt.id}')"
              style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-right: 6px;"
            >
              üí∞ –û–ø–ª–∞—Ç–∏—Ç—å
            </button>
          ` : ''}
          <button 
            onclick="window.showPaymentHistory('${debt.id}')"
            style="padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;"
          >
            üìã –ò—Å—Ç–æ—Ä–∏—è
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

// =============================================
// –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –î–û–õ–ì–û–í
// =============================================

window.filterDebts = async function() {
  const status = document.getElementById('debtsStatusFilter')?.value || 'all';
  const search = document.getElementById('debtsSearchInput')?.value.toLowerCase() || '';

  try {
    const debts = await loadSupplierDebts(window.COMPANY_ID, status);
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–∏—Å–∫—É
    const filtered = search 
      ? debts.filter(debt => {
          const supplierName = (debt.supplier?.name || debt.supplier_name || '').toLowerCase();
          return supplierName.includes(search);
        })
      : debts;

    currentDebts = filtered;
    renderDebtsTable(filtered);

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', error);
    window.showToast('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
};

// =============================================
// –û–¢–ö–†–´–¢–ò–ï –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –û–ü–õ–ê–¢–´
// =============================================

window.openPayDebtModal = async function(debtId) {
  try {
    const debt = await loadDebtWithPayments(debtId);
    selectedDebt = debt;

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–ª–≥–µ
    const infoContainer = document.getElementById('payDebtInfo');
    if (infoContainer) {
      infoContainer.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${debt.supplier?.name || debt.supplier_name}
        </div>
        <div style="margin-bottom: 8px;">
          <strong>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> ${window.formatDate(debt.created_at)}
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
          <div>
            <div style="font-size: 12px; color: #6b7280;">–°—É–º–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
            <div style="font-size: 16px; font-weight: 600; color: #111827;">${Number(debt.total_amount).toFixed(2)} ‚Ç∏</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;">–û–ø–ª–∞—á–µ–Ω–æ</div>
            <div style="font-size: 16px; font-weight: 600; color: #10b981;">${Number(debt.paid_amount).toFixed(2)} ‚Ç∏</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;">–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞</div>
            <div style="font-size: 16px; font-weight: 600; color: #ef4444;">${Number(debt.debt_amount).toFixed(2)} ‚Ç∏</div>
          </div>
        </div>
      `;
    }

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å—É–º–º—É
    const amountInput = document.getElementById('payDebtAmount');
    const maxAmountSpan = document.getElementById('payDebtMaxAmount');
    if (amountInput && maxAmountSpan) {
      amountInput.max = debt.debt_amount;
      amountInput.value = debt.debt_amount;
      maxAmountSpan.textContent = Number(debt.debt_amount).toFixed(2);
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–æ–¥—ã –æ–ø–ª–∞—Ç—ã
    const methodSelect = document.getElementById('payDebtMethod');
    if (methodSelect && window.PAYMENT_METHODS) {
      methodSelect.innerHTML = window.PAYMENT_METHODS.map(method => 
        `<option value="${method.id}">${method.name}</option>`
      ).join('');
    }

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    window.openModal('modalPayDebt');

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
    window.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö', 'error');
  }
};

// =============================================
// –û–¢–ü–†–ê–í–ö–ê –û–ü–õ–ê–¢–´
// =============================================

window.submitPayment = async function(event) {
  event.preventDefault();

  if (!selectedDebt) {
    window.showToast('–î–æ–ª–≥ –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
    return;
  }

  const form = event.target;
  const amount = parseFloat(form.amount.value);
  const paymentMethodId = form.paymentMethod.value;
  const comment = form.comment.value;

  // –í–∞–ª–∏–¥–∞—Ü–∏—è
  const validation = validatePayment(selectedDebt, amount);
  if (!validation.valid) {
    window.showToast(validation.error, 'error');
    return;
  }

  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';

    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–ª–∞—Ç—É
    await paySupplierDebt(selectedDebt.id, amount, paymentMethodId, comment);

    // –£—Å–ø–µ—Ö
    window.showToast(`–û–ø–ª–∞—Ç–∞ –Ω–∞ —Å—É–º–º—É ${amount.toFixed(2)} ‚Ç∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞`, 'success');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    window.closeModal('modalPayDebt');
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await window.loadDebtsPage();

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã:', error);
    window.showToast('–û—à–∏–±–∫–∞: ' + error.message, 'error');
    
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = false;
    submitBtn.textContent = 'üí∞ –û–ø–ª–∞—Ç–∏—Ç—å';
  }
};

// =============================================
// –ü–û–ö–ê–ó–ê–¢–¨ –ò–°–¢–û–†–ò–Æ –û–ü–õ–ê–¢
// =============================================

window.showPaymentHistory = async function(debtId) {
  try {
    const debt = await loadDebtWithPayments(debtId);

    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–ª–≥–µ
    const infoContainer = document.getElementById('historyDebtInfo');
    if (infoContainer) {
      infoContainer.innerHTML = `
        <div style="margin-bottom: 8px;">
          <strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> ${debt.supplier?.name || debt.supplier_name}
        </div>
        <div style="margin-bottom: 8px;">
          <strong>–î–∞—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</strong> ${window.formatDate(debt.created_at)}
        </div>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px;">
          <div>
            <div style="font-size: 12px; color: #6b7280;">–°—É–º–º–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞</div>
            <div style="font-size: 16px; font-weight: 600; color: #111827;">${Number(debt.total_amount).toFixed(2)} ‚Ç∏</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;">–û–ø–ª–∞—á–µ–Ω–æ</div>
            <div style="font-size: 16px; font-weight: 600; color: #10b981;">${Number(debt.paid_amount).toFixed(2)} ‚Ç∏</div>
          </div>
          <div>
            <div style="font-size: 12px; color: #6b7280;">–û—Å—Ç–∞—Ç–æ–∫</div>
            <div style="font-size: 16px; font-weight: 600; color: ${debt.status === 'closed' ? '#10b981' : '#ef4444'};">
              ${Number(debt.debt_amount).toFixed(2)} ‚Ç∏
            </div>
          </div>
        </div>
      `;
    }

    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–ª–∞—Ç
    const listContainer = document.getElementById('paymentHistoryList');
    if (listContainer) {
      if (!debt.payments || debt.payments.length === 0) {
        listContainer.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #9ca3af;">
            –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç –ø—É—Å—Ç–∞
          </div>
        `;
      } else {
        listContainer.innerHTML = debt.payments.map(payment => `
          <div style="padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 600; color: #111827; margin-bottom: 4px;">
                  ${Number(payment.amount).toFixed(2)} ‚Ç∏
                </div>
                <div style="font-size: 13px; color: #6b7280;">
                  ${payment.payment_method_name}
                </div>
              </div>
              <div style="text-align: right; font-size: 13px; color: #6b7280;">
                ${window.formatDate(payment.paid_at)}
              </div>
            </div>
            ${payment.comment ? `
              <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; font-size: 13px; color: #6b7280;">
                ${payment.comment}
              </div>
            ` : ''}
          </div>
        `).join('');
      }
    }

    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
    window.openModal('modalPaymentHistory');

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
    window.showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–ª–∞—Ç', 'error');
  }
};

// –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å–µ–∫—Ü–∏–∏
document.addEventListener('DOMContentLoaded', () => {
  // –ï—Å–ª–∏ —Å–µ–∫—Ü–∏—è –¥–æ–ª–≥–æ–≤ –∞–∫—Ç–∏–≤–Ω–∞ - –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
  const debtsSection = document.getElementById('section-supplier-debts');
  if (debtsSection && debtsSection.style.display !== 'none') {
    window.loadDebtsPage();
  }
});

</script>
